//@version=5
indicator("Combined Indicator: Ichimoku + SMC + Flux OB", shorttitle="Combined", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500)

// ============================================================================
// COPYRIGHT - Ú©Ù¾ÛŒ Ø±Ø§ÛŒØª
// ============================================================================
// Â© 2025 Ø¢Ø±Ù…ÛŒÙ† Ø§Ù„Ø¨Ø±Ø²ÛŒ - rmin.alborzi@gmail.com
// Combined Indicator: Ichimoku + SMC + Flux Order Blocks
// ============================================================================

// ============================================================================
// INPUT CONTROLS - ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ
// ============================================================================

// === Module Toggles - ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ ===
showIchimoku = input.bool(true, "ðŸ“Š Show Ichimoku Cloud", group="Module Controls", inline="ich")
showSMC = input.bool(true, "ðŸ§  Show SMC Suite", group="Module Controls", inline="smc")
showOB = input.bool(true, "ðŸ“¦ Show Order Blocks", group="Module Controls", inline="ob")

// === Ichimoku Settings - ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ ===
ichTenkanPeriod = input.int(9, "Tenkan Period", minval=1, group="Ichimoku Settings")
ichKijunPeriod = input.int(26, "Kijun Period", minval=1, group="Ichimoku Settings")
ichSenkouBPeriod = input.int(52, "Senkou Span B Period", minval=1, group="Ichimoku Settings")
ichDisplacement = input.int(26, "Displacement", minval=1, group="Ichimoku Settings")

// Ichimoku Colors
ichCloudBullColor = input.color(color.new(color.green, 80), "Bullish Cloud Color", group="Ichimoku Colors")
ichCloudBearColor = input.color(color.new(color.red, 80), "Bearish Cloud Color", group="Ichimoku Colors")
ichTenkanColor = input.color(color.new(color.blue, 0), "Tenkan Line Color", group="Ichimoku Colors")
ichKijunColor = input.color(color.new(color.red, 0), "Kijun Line Color", group="Ichimoku Colors")
ichChikouColor = input.color(color.new(color.lime, 0), "Chikou Span Color", group="Ichimoku Colors")
ichSpanAColor = input.color(color.new(color.green, 0), "Senkou Span A Color", group="Ichimoku Colors")
ichSpanBColor = input.color(color.new(color.red, 0), "Senkou Span B Color", group="Ichimoku Colors")

// Ichimoku Line Width
ichLineWidth = input.int(1, "Line Width", minval=1, maxval=5, group="Ichimoku Colors")

// === SMC Settings - ØªÙ†Ø¸ÛŒÙ…Ø§Øª SMC ===
smcLookback = input.int(20, "SMC Lookback Period", minval=5, group="SMC Settings")
smcSensitivity = input.float(0.5, "Structure Sensitivity", minval=0.1, maxval=2.0, step=0.1, group="SMC Settings")
smcShowLabels = input.bool(true, "Show BOS/CHoCH Labels", group="SMC Settings")
smcShowLines = input.bool(true, "Show Structure Lines", group="SMC Settings")

// SMC Colors
smcBOSColor = input.color(color.new(color.blue, 0), "BOS Color", group="SMC Colors")
smcCHOCHColor = input.color(color.new(color.orange, 0), "CHoCH Color", group="SMC Colors")
smcEntryBullColor = input.color(color.new(color.green, 0), "Bullish Entry Color", group="SMC Colors")
smcEntryBearColor = input.color(color.new(color.red, 0), "Bearish Entry Color", group="SMC Colors")
smcLabelSize = input.string("normal", "Label Size", options=["small", "normal", "large"], group="SMC Colors")

// === Order Blocks Settings - ØªÙ†Ø¸ÛŒÙ…Ø§Øª Order Blocks ===
obLookback = input.int(50, "OB Lookback Period", minval=10, group="Order Blocks Settings")
obVolumeThreshold = input.float(1.5, "Volume Threshold Multiplier", minval=1.0, step=0.1, group="Order Blocks Settings")
obShowBorders = input.bool(true, "Show OB Borders", group="Order Blocks Settings")
obExtendBars = input.int(20, "Extend OB Bars", minval=5, group="Order Blocks Settings")

// Order Blocks Colors
obBullColor = input.color(color.new(color.teal, 70), "Bullish OB Color", group="Order Blocks Colors")
obBearColor = input.color(color.new(color.maroon, 70), "Bearish OB Color", group="Order Blocks Colors")
obBorderColor = input.color(color.new(color.white, 50), "OB Border Color", group="Order Blocks Colors")
obBorderWidth = input.int(1, "Border Width", minval=1, maxval=3, group="Order Blocks Colors")

// ============================================================================
// ICHIMOKU CALCULATIONS - Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
// ============================================================================

// Ù…Ø­Ø§Ø³Ø¨Ù‡ HLC3 (High + Low + Close) / 3
hlc3_value = (high + low + close) / 3

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®Ø·ÙˆØ· Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
tenkan_sen = ta.sma(hlc3_value, ichTenkanPeriod)
kijun_sen = ta.sma(hlc3_value, ichKijunPeriod)
senkou_span_a = (tenkan_sen + kijun_sen) / 2
senkou_span_b = ta.sma(hlc3_value, ichSenkouBPeriod)
chikou_span = close[ichDisplacement]

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø¨Ø± Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
senkou_span_a_shifted = senkou_span_a[ichDisplacement]
senkou_span_b_shifted = senkou_span_b[ichDisplacement]

// ØªØ¹ÛŒÛŒÙ† Ø±Ù†Ú¯ Ø§Ø¨Ø±
cloud_color = senkou_span_a_shifted > senkou_span_b_shifted ? ichCloudBullColor : ichCloudBearColor

// ============================================================================
// SMC CALCULATIONS - Ù…Ø­Ø§Ø³Ø¨Ø§Øª SMC
// ============================================================================

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ù‚Ù Ùˆ Ú©Ù Ø³Ø§Ø®ØªØ§Ø±ÛŒ
highest_high = ta.highest(high, smcLookback)
lowest_low = ta.lowest(low, smcLookback)

// ØªØ´Ø®ÛŒØµ BOS (Break of Structure)
bos_bull = high > highest_high[1] and close > close[1]
bos_bear = low < lowest_low[1] and close < close[1]

// ØªØ´Ø®ÛŒØµ CHoCH (Change of Character)
choch_bull = low < lowest_low[1] and close > close[1]
choch_bear = high > highest_high[1] and close < close[1]

// ============================================================================
// ORDER BLOCKS CALCULATIONS - Ù…Ø­Ø§Ø³Ø¨Ø§Øª Order Blocks
// ============================================================================

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¬Ù… Ù…ØªÙˆØ³Ø·
avg_volume = ta.sma(volume, 20)
high_volume = volume > avg_volume * obVolumeThreshold

// ØªØ´Ø®ÛŒØµ Order Block ØµØ¹ÙˆØ¯ÛŒ (Bullish OB)
bullish_ob = high_volume and close > open and close > close[1] and low < low[1]
bearish_ob = high_volume and close < open and close < close[1] and high > high[1]

// Ø°Ø®ÛŒØ±Ù‡ Order Block Ù‡Ø§
var float ob_bull_high = na
var float ob_bull_low = na
var int ob_bull_bar = na
var float ob_bear_high = na
var float ob_bear_low = na
var int ob_bear_bar = na

if bullish_ob and showOB
    ob_bull_high := high
    ob_bull_low := low
    ob_bull_bar := bar_index

if bearish_ob and showOB
    ob_bear_high := high
    ob_bear_low := low
    ob_bear_bar := bar_index

// ============================================================================
// PLOTTING - Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§
// ============================================================================

// === Ichimoku Plots ===
// Ø®Ø·ÙˆØ· Ø§ØµÙ„ÛŒ
plot(showIchimoku ? tenkan_sen : na, color=ichTenkanColor, linewidth=ichLineWidth, title="Tenkan-sen")
plot(showIchimoku ? kijun_sen : na, color=ichKijunColor, linewidth=ichLineWidth, title="Kijun-sen")

// Senkou Spans
plot(showIchimoku ? senkou_span_a_shifted : na, color=ichSpanAColor, linewidth=ichLineWidth, title="Senkou Span A")
plot(showIchimoku ? senkou_span_b_shifted : na, color=ichSpanBColor, linewidth=ichLineWidth, title="Senkou Span B")

// Chikou Span
plot(showIchimoku ? chikou_span : na, color=ichChikouColor, linewidth=ichLineWidth, title="Chikou Span")

// Ø§Ø¨Ø± Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
fill(plot(showIchimoku ? senkou_span_a_shifted : na), plot(showIchimoku ? senkou_span_b_shifted : na), color=showIchimoku ? cloud_color : na, title="Ichimoku Cloud")

// === SMC Plots ===
if showSMC
    // BOS Labels
    if smcShowLabels and bos_bull
        label.new(bar_index, high, "BOS â†‘", color=smcBOSColor, textcolor=color.white, style=label.style_label_down, size=smcLabelSize == "small" ? size.small : smcLabelSize == "large" ? size.large : size.normal)
    
    if smcShowLabels and bos_bear
        label.new(bar_index, low, "BOS â†“", color=smcBOSColor, textcolor=color.white, style=label.style_label_up, size=smcLabelSize == "small" ? size.small : smcLabelSize == "large" ? size.large : size.normal)
    
    // CHoCH Labels
    if smcShowLabels and choch_bull
        label.new(bar_index, low, "CHoCH â†‘", color=smcCHOCHColor, textcolor=color.white, style=label.style_label_up, size=smcLabelSize == "small" ? size.small : smcLabelSize == "large" ? size.large : size.normal)
    
    if smcShowLabels and choch_bear
        label.new(bar_index, high, "CHoCH â†“", color=smcCHOCHColor, textcolor=color.white, style=label.style_label_down, size=smcLabelSize == "small" ? size.small : smcLabelSize == "large" ? size.large : size.normal)
    
    // Structure Lines
    if smcShowLines
        if bos_bull
            line.new(bar_index[1], highest_high[1], bar_index, highest_high[1], color=smcBOSColor, width=1, style=line.style_dashed)
        if bos_bear
            line.new(bar_index[1], lowest_low[1], bar_index, lowest_low[1], color=smcBOSColor, width=1, style=line.style_dashed)

// === Order Blocks Plots ===
if showOB
    // Bullish Order Block
    if not na(ob_bull_high) and not na(ob_bull_low) and not na(ob_bull_bar)
        if bar_index - ob_bull_bar <= obExtendBars
            box.new(ob_bull_bar, ob_bull_high, bar_index, ob_bull_low, border_color=obShowBorders ? obBorderColor : na, border_width=obShowBorders ? obBorderWidth : 0, bgcolor=obBullColor, extend=extend.right)
    
    // Bearish Order Block
    if not na(ob_bear_high) and not na(ob_bear_low) and not na(ob_bear_bar)
        if bar_index - ob_bear_bar <= obExtendBars
            box.new(ob_bear_bar, ob_bear_high, bar_index, ob_bear_low, border_color=obShowBorders ? obBorderColor : na, border_width=obShowBorders ? obBorderWidth : 0, bgcolor=obBearColor, extend=extend.right)

// ============================================================================
// ALERTS - Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
// ============================================================================

// Ichimoku Alerts
alertcondition(showIchimoku and close > senkou_span_a_shifted and close[1] <= senkou_span_a_shifted[1], title="Ichimoku: Price Above Cloud", message="Price moved above Ichimoku Cloud")
alertcondition(showIchimoku and close < senkou_span_b_shifted and close[1] >= senkou_span_b_shifted[1], title="Ichimoku: Price Below Cloud", message="Price moved below Ichimoku Cloud")

// SMC Alerts
alertcondition(showSMC and bos_bull, title="SMC: Bullish BOS", message="Bullish Break of Structure detected")
alertcondition(showSMC and bos_bear, title="SMC: Bearish BOS", message="Bearish Break of Structure detected")
alertcondition(showSMC and choch_bull, title="SMC: Bullish CHoCH", message="Bullish Change of Character detected")
alertcondition(showSMC and choch_bear, title="SMC: Bearish CHoCH", message="Bearish Change of Character detected")

// Order Blocks Alerts
alertcondition(showOB and bullish_ob, title="OB: Bullish Order Block", message="Bullish Order Block formed")
alertcondition(showOB and bearish_ob, title="OB: Bearish Order Block", message="Bearish Order Block formed")

// ============================================================================
// TABLE INFO - Ø¬Ø¯ÙˆÙ„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
// ============================================================================

if barstate.islast and (showIchimoku or showSMC or showOB)
    var table info_table = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1)
    
    table.cell(info_table, 0, 0, "Indicator", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 0, "Status", text_color=color.white, text_size=size.small)
    
    table.cell(info_table, 0, 1, "Ichimoku", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 1, showIchimoku ? "âœ… Active" : "âŒ Inactive", text_color=showIchimoku ? color.green : color.red, text_size=size.small)
    
    table.cell(info_table, 0, 2, "SMC Suite", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 2, showSMC ? "âœ… Active" : "âŒ Inactive", text_color=showSMC ? color.green : color.red, text_size=size.small)
    
    table.cell(info_table, 0, 3, "Order Blocks", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 3, showOB ? "âœ… Active" : "âŒ Inactive", text_color=showOB ? color.green : color.red, text_size=size.small)
    
    table.cell(info_table, 0, 4, "Cloud Status", text_color=color.white, text_size=size.small)
    cloud_status = close > senkou_span_a_shifted and close > senkou_span_b_shifted ? "ðŸŸ¢ Bullish" : close < senkou_span_a_shifted and close < senkou_span_b_shifted ? "ðŸ”´ Bearish" : "ðŸŸ¡ Neutral"
    table.cell(info_table, 1, 4, cloud_status, text_color=color.white, text_size=size.small)
    
    table.cell(info_table, 0, 5, "Last BOS", text_color=color.white, text_size=size.small)
    last_bos = bos_bull ? "ðŸŸ¢ Bull" : bos_bear ? "ðŸ”´ Bear" : "âšª None"
    table.cell(info_table, 1, 5, last_bos, text_color=color.white, text_size=size.small)

// ============================================================================
// COPYRIGHT DISPLAY - Ù†Ù…Ø§ÛŒØ´ Ú©Ù¾ÛŒ Ø±Ø§ÛŒØª
// ============================================================================

if barstate.islast
    var table copyright_table = table.new(position.top_right, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)
    table.cell(copyright_table, 0, 0, "Â© 2025 Ø¢Ø±Ù…ÛŒÙ† Ø§Ù„Ø¨Ø±Ø²ÛŒ", text_color=color.new(color.lime, 0), text_size=size.tiny)
